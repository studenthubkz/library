<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–û–ø–ª–∞—Ç–∞ - –û–Ω–ª–∞–π–Ω –∫—ñ—Ç–∞–ø—Ö–∞–Ω–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f4e8;
            color: #3c3c3c;
            line-height: 1.6;
            padding: 20px;
        }
        
        .payment-container {
            max-width: 500px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .book-info {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .book-title {
            font-size: 24px;
            font-weight: 600;
            color: #5a3e2b;
            margin-bottom: 5px;
        }
        
        .book-price {
            font-size: 20px;
            color: #d4a373;
            font-weight: 500;
        }
        
        .payment-methods {
            margin: 20px 0;
        }
        
        .payment-method {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .payment-method:hover, .payment-method.active {
            border-color: #d4a373;
            background-color: #f5e6cc;
        }
        
        .payment-method.active {
            border-width: 2px;
        }
        
        .payment-details {
            margin-top: 20px;
        }
        
        .btn-primary {
            background-color: #d4a373;
            border-color: #d4a373;
            padding: 10px 20px;
            font-size: 16px;
        }
        
        .btn-primary:hover {
            background-color: #c48c52;
            border-color: #c48c52;
        }
        
        .form-control:focus {
            border-color: #d4a373;
            box-shadow: 0 0 5px rgba(212, 163, 115, 0.5);
        }
        
        .card-image {
            max-width: 100%;
            height: 40px;
            margin-right: 10px;
        }
        
        .success-animation {
            text-align: center;
            margin: 30px 0;
            position: relative;
        }
        
        .checkmark {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: block;
            stroke-width: 2;
            stroke: #4bb71b;
            stroke-miterlimit: 10;
            box-shadow: inset 0px 0px 0px #4bb71b;
            animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }
        
        .checkmark__circle {
            stroke-dasharray: 166;
            stroke-dashoffset: 166;
            stroke-width: 2;
            stroke-miterlimit: 10;
            stroke: #4bb71b;
            fill: none;
            animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
        }
        
        .checkmark__check {
            transform-origin: 50% 50%;
            stroke-dasharray: 48;
            stroke-dashoffset: 48;
            animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
        }
        
        @keyframes stroke {
            100% {
                stroke-dashoffset: 0;
            }
        }
        
        @keyframes scale {
            0%, 100% {
                transform: none;
            }
            50% {
                transform: scale3d(1.1, 1.1, 1);
            }
        }
        
        @keyframes fill {
            100% {
                box-shadow: inset 0px 0px 0px 30px #4bb71b;
            }
        }
        
        .success-rays {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            height: 150px;
            z-index: 1;
        }
        
        .success-rays:before, .success-rays:after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: #4bb71b;
            border-bottom-color: #4bb71b;
            animation: rotateCircle 2s linear infinite;
        }
        
        .success-rays:after {
            border-top-color: #d4a373;
            border-bottom-color: #d4a373;
            animation-duration: 3s;
        }
        
        @keyframes rotateCircle {
            0% {
                transform: rotate(0);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }
        
        @keyframes confettiFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        
        .loading-overlay.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #d4a373;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        .loader-message {
            color: #5a3e2b;
            font-size: 18px;
            margin-top: 15px;
            font-weight: 500;
        }
        
        .loader-progress {
            width: 200px;
            height: 6px;
            background-color: #f3f3f3;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .loader-progress-bar {
            height: 100%;
            width: 0%;
            background-color: #d4a373;
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .payment-success-card {
            animation: successCardAppear 0.8s ease forwards;
            transform-origin: center;
            opacity: 0;
        }
        
        @keyframes successCardAppear {
            0% {
                transform: scale(0.7);
                opacity: 0;
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .success-message {
            animation: fadeInUp 0.6s ease 0.5s forwards;
            opacity: 0;
            transform: translateY(20px);
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .card-icon {
            display: inline-block;
            margin-right: 5px;
            animation: cardIconPulse 1.5s infinite ease-in-out;
        }
        
        @keyframes cardIconPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }
        
        .payment-method.active {
            border-width: 2px;
            animation: selectedPaymentPulse 2s infinite;
        }
        
        @keyframes selectedPaymentPulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(212, 163, 115, 0.4);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(212, 163, 115, 0);
            }
        }
    </style>
</head>
<body>
    <!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loader-message" id="loaderMessage">–¢”©–ª–µ–º ”©“£–¥–µ–ª—É–¥–µ...</div>
        <div class="loader-progress">
            <div class="loader-progress-bar" id="loaderProgressBar"></div>
        </div>
    </div>
    
    <div class="container" id="payment-content">
        <div class="payment-container" id="payment-form">
            <div class="book-info">
                <h1 class="book-title" id="book-title">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</h1>
                <div class="book-price" id="book-price"></div>
                <p class="text-muted mt-2" id="user-info"></p>
            </div>
            
            <div class="payment-methods">
                <h5>–¢”©–ª–µ–º ”ô–¥—ñ—Å—ñ–Ω —Ç–∞“£–¥–∞“£—ã–∑:</h5>
                <div class="payment-method active" onclick="selectPaymentMethod(this, 'card')">
                    <div class="d-flex align-items-center">
                        <img src="https://cdn-icons-png.flaticon.com/512/196/196578.png" alt="–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞" class="card-image">
                        <span>–ö—Ä–µ–¥–∏—Ç—Ç—ñ–∫/–¥–µ–±–µ—Ç—Ç—ñ–∫ –∫–∞—Ä—Ç–∞</span>
                    </div>
                </div>
                <div class="payment-method" onclick="selectPaymentMethod(this, 'kaspi')">
                    <div class="d-flex align-items-center">
                        <img src="https://play-lh.googleusercontent.com/VhOHKfhODiZ1FOobLOaVhJLQkUVnrNZZ5Xc5S1QxiMvYAOeL4TkSHlZxZp4_BLs0dg" alt="Kaspi" class="card-image">
                        <span>Kaspi QR/Kaspi Pay</span>
                    </div>
                </div>
            </div>
            
            <div class="payment-details" id="card-details">
                <div class="mb-3">
                    <label for="card-number" class="form-label">–ö–∞—Ä—Ç–∞ –Ω”©–º—ñ—Ä—ñ:</label>
                    <input type="text" class="form-control" id="card-number" placeholder="XXXX XXXX XXXX XXXX">
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <label for="expiry-date" class="form-label">–ú–µ—Ä–∑—ñ–º—ñ:</label>
                        <input type="text" class="form-control" id="expiry-date" placeholder="MM/YY">
                    </div>
                    <div class="col">
                        <label for="cvv" class="form-label">CVV:</label>
                        <input type="password" class="form-control" id="cvv" placeholder="XXX">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="card-holder" class="form-label">–ö–∞—Ä—Ç–∞ –∏–µ—Å—ñ–Ω—ñ“£ –∞—Ç—ã-–∂”©–Ω—ñ:</label>
                    <input type="text" class="form-control" id="card-holder" placeholder="IVAN IVANOV">
                </div>
            </div>
            
            <div class="payment-details d-none" id="kaspi-details">
                <div class="text-center">
                    <p>Kaspi QR-–∫–æ–¥—Ç—ã —Å–∫–∞–Ω–µ—Ä–ª–µ“£—ñ–∑ –Ω–µ–º–µ—Å–µ Kaspi Pay-–¥—ñ –ø–∞–π–¥–∞–ª–∞–Ω—ã“£—ã–∑:</p>
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=kaspi://transfer?token=example" alt="Kaspi QR –∫–æ–¥" class="img-fluid my-3" style="max-width: 200px;">
                    <p class="text-muted">–¢–µ–ª–µ—Ñ–æ–Ω–¥–∞ Kaspi QR —Å–∫–∞–Ω–µ—Ä–ª–µ—É–¥—ñ –Ω–µ–º–µ—Å–µ Kaspi Pay –ø–∞–π–¥–∞–ª–∞–Ω—ã–ø —Ç”©–ª–µ–º–¥—ñ –∞—è“õ—Ç–∞“£—ã–∑</p>
                </div>
            </div>
            
            <div class="mt-4 text-center">
                <button type="button" class="btn btn-primary" onclick="processPayment()">–¢”©–ª–µ–º–¥—ñ –∞—è“õ—Ç–∞—É</button>
            </div>
        </div>
        
        <div class="payment-container d-none payment-success-card" id="success-container">
            <div class="success-animation">
                <div class="success-rays"></div>
                <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                    <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
            </div>
            <div class="text-center success-message">
                <h3>–¢”©–ª–µ–º —Å”ô—Ç—Ç—ñ! <span class="card-icon">üí≥</span></h3>
                <p id="success-message">–¢”©–ª–µ–º—ñ“£—ñ–∑ —Å”ô—Ç—Ç—ñ ”©“£–¥–µ–ª–¥—ñ.</p>
                <p>–ö—ñ—Ç–∞–ø —Å–∞—Ç—ã–ø –∞–ª—ã–Ω“ì–∞–Ω–Ω–∞–Ω –∫–µ–π—ñ–Ω, –æ–ª —Å—ñ–∑–¥—ñ“£ "–ú–µ–Ω—ñ“£ –∫—ñ—Ç–∞–ø—Ç–∞—Ä—ã–º" –±”©–ª—ñ–º—ñ“£—ñ–∑–≥–µ –∞–≤—Ç–æ–º–∞—Ç—Ç—ã —Ç“Ø—Ä–¥–µ “õ–æ—Å—ã–ª–∞–¥—ã.</p>
                <a href="/" class="btn btn-primary mt-3">–ë–∞—Å—Ç—ã –±–µ—Ç–∫–µ –æ—Ä–∞–ª—É</a>
            </div>
        </div>
    </div>

    <script>
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.io
        const socket = io();
        
        // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const bookTitle = urlParams.get('book');
        const bookPrice = urlParams.get('price');
        const userData = urlParams.get('user');
        const sessionId = urlParams.get('session');
        const bookId = urlParams.get('bookId');
        const userId = urlParams.get('userId');
        
        // –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã
        let currentPaymentMethod = 'card';
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        document.addEventListener('DOMContentLoaded', function() {
            if (bookTitle) {
                document.getElementById('book-title').textContent = bookTitle;
            }
            
            if (bookPrice) {
                document.getElementById('book-price').textContent = `–ë–∞“ì–∞—Å—ã: ${bookPrice} ‚Ç∏`;
            }
            
            if (userData) {
                document.getElementById('user-info').textContent = `“ö–æ–ª–¥–∞–Ω—É—à—ã: ${userData}`;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ—Å—Å–∏–∏
            if (sessionId) {
                // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ —Å–µ—Å—Å–∏–∏ –æ–ø–ª–∞—Ç—ã
                socket.emit('join-payment-session', sessionId);
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–µ—Å—Å–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
                fetch(`/api/payment-session/${sessionId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.session) {
                            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å —É–∂–µ "completed", –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
                            if (data.session.status === 'completed') {
                                showPaymentSuccess();
                            }
                        }
                    })
                    .catch(error => {
                        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å–µ—Å—Å–∏–∏:', error);
                    });
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç—ã
            const cardNumberInput = document.getElementById('card-number');
            if (cardNumberInput) {
                cardNumberInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 16) value = value.slice(0, 16);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª—ã –∫–∞–∂–¥—ã–µ 4 —Ü–∏—Ñ—Ä—ã
                    const formatted = value.replace(/(\d{4})(?=\d)/g, '$1 ');
                    e.target.value = formatted;
                });
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ä–æ–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è
            const expiryDateInput = document.getElementById('expiry-date');
            if (expiryDateInput) {
                expiryDateInput.addEventListener('input', function(e) {
                    let value = e.target.value.replace(/\D/g, '');
                    if (value.length > 4) value = value.slice(0, 4);
                    
                    if (value.length > 2) {
                        value = value.slice(0, 2) + '/' + value.slice(2);
                    }
                    
                    e.target.value = value;
                });
            }
        });
        
        // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
        function selectPaymentMethod(element, method) {
            // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å active —É –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤ –æ–ø–ª–∞—Ç—ã
            document.querySelectorAll('.payment-method').forEach(el => {
                el.classList.remove('active');
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å active –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –º–µ—Ç–æ–¥—É
            element.classList.add('active');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –º–µ—Ç–æ–¥ –æ–ø–ª–∞—Ç—ã
            currentPaymentMethod = method;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ñ–æ—Ä–º—ã –¥–µ—Ç–∞–ª–µ–π –æ–ø–ª–∞—Ç—ã
            document.querySelectorAll('.payment-details').forEach(el => {
                el.classList.add('d-none');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–µ—Ç–∞–ª–µ–π –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã
            document.getElementById(`${method}-details`).classList.remove('d-none');
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞ —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π
        function processPayment() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            showLoading(true);
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞ –æ–ø–ª–∞—Ç—ã
            if (currentPaymentMethod === 'card') {
                const cardNumber = document.getElementById('card-number').value.trim();
                const expiryDate = document.getElementById('expiry-date').value.trim();
                const cvv = document.getElementById('cvv').value.trim();
                const cardHolder = document.getElementById('card-holder').value.trim();
                
                // –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è)
                if (!cardNumber || !expiryDate || !cvv || !cardHolder) {
                    alert('–ë–∞—Ä–ª—ã“õ ”©—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Ç–æ–ª—Ç—ã—Ä—ã“£—ã–∑');
                    showLoading(false);
                    return;
                }
            }
            
            // –≠–º—É–ª–∏—Ä—É–µ–º —ç—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
            updateLoaderMessage('–¢”©–ª–µ–º –¥–µ—Ä–µ–∫—Ç–µ—Ä—ñ —Ç–µ–∫—Å–µ—Ä—ñ–ª—É–¥–µ...');
            updateProgressBar(20);
            
            setTimeout(() => {
                updateLoaderMessage('–ë–∞–Ω–∫–ø–µ–Ω –±–∞–π–ª–∞–Ω—ã—Å—É...');
                updateProgressBar(40);
                
                setTimeout(() => {
                    updateLoaderMessage('–¢”©–ª–µ–º–¥—ñ ”©“£–¥–µ—É...');
                    updateProgressBar(70);
                    
                    setTimeout(() => {
                        updateLoaderMessage('–¢”©–ª–µ–º –∞—è“õ—Ç–∞–ª—É–¥–∞...');
                        updateProgressBar(90);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–ª–∞—Ç–µ–∂–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
                        fetch('/api/payment-status', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 
                                sessionId: sessionId,
                                status: 'completed'
                            }),
                        })
                        .then(response => response.json())
                        .then(data => {
                            updateProgressBar(100);
                            
                            setTimeout(() => {
                                showLoading(false);
                                
                                if (data.success) {
                                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebSocket
                                    socket.emit('payment-status-update', {
                                        sessionId: sessionId,
                                        status: 'completed',
                                        bookId: parseInt(bookId),
                                        userId: parseInt(userId)
                                    });
                                    
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
                                    showPaymentSuccess();
                                } else {
                                    alert(data.message || '–¢”©–ª–µ–º –∫–µ–∑—ñ–Ω–¥–µ “õ–∞—Ç–µ –æ—Ä—ã–Ω –∞–ª–¥—ã');
                                }
                            }, 500);
                        })
                        .catch(error => {
                            showLoading(false);
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞:', error);
                            alert('–°–µ—Ä–≤–µ—Ä–≥–µ “õ–æ—Å—ã–ª—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã. –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –±–∞–π–ª–∞–Ω—ã—Å—ã–Ω —Ç–µ–∫—Å–µ—Ä—ñ“£—ñ–∑.');
                        });
                    }, 700);
                }, 800);
            }, 600);
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑—á–∏–∫–∞
        function updateLoaderMessage(message) {
            document.getElementById('loaderMessage').textContent = message;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        function updateProgressBar(percent) {
            document.getElementById('loaderProgressBar').style.width = `${percent}%`;
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —ç–∫—Ä–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
        function showPaymentSuccess() {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç–µ
            document.getElementById('success-message').textContent = `"${bookTitle}" –∫—ñ—Ç–∞–±—ã “Ø—à—ñ–Ω —Ç”©–ª–µ–º—ñ“£—ñ–∑ —Å”ô—Ç—Ç—ñ ”©“£–¥–µ–ª–¥—ñ.`;
            
            // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –æ–ø–ª–∞—Ç—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
            document.getElementById('payment-form').classList.add('d-none');
            const successContainer = document.getElementById('success-container');
            successContainer.classList.remove('d-none');
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
            createConfetti();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –≤ URL –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            const redirectUrl = new URL('/', window.location.origin);
            redirectUrl.searchParams.append('payment_success', 'true');
            redirectUrl.searchParams.append('sessionId', sessionId);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            document.querySelector('#success-container a.btn').href = redirectUrl.toString();
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏
        function showLoading(show = true) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (show) {
                loadingOverlay.classList.add('show');
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º –ø–æ–∫–∞–∑–µ
                updateProgressBar(0);
            } else {
                loadingOverlay.classList.remove('show');
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –∫–æ–Ω—Ñ–µ—Ç—Ç–∏
        function createConfetti() {
            const colors = ['#d4a373', '#4bb71b', '#ffd166', '#ef476f', '#118ab2'];
            const container = document.getElementById('success-container');
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                confetti.style.animation = 'confettiFall 3s forwards';
                container.appendChild(confetti);
            }
            
            // –£–±–∏—Ä–∞–µ–º –∫–æ–Ω—Ñ–µ—Ç—Ç–∏ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                const confettiElements = document.querySelectorAll('.confetti');
                confettiElements.forEach(elem => {
                    elem.remove();
                });
            }, 5000);
        }
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –æ–ø–ª–∞—Ç—ã –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        socket.on('payment-status-changed', function(data) {
            console.log('–ü–æ–ª—É—á–µ–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø–ª–∞—Ç–µ–∂–∞:', data);
            
            // –ï—Å–ª–∏ —Å—Ç–∞—Ç—É—Å "completed", –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
            if (data.status === 'completed') {
                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –±—ã–ª–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ —Ä–∞–Ω—å—à–µ
                if (!bookTitle || bookTitle === '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...') {
                    fetch(`/api/books`)
                        .then(response => response.json())
                        .then(booksData => {
                            if (booksData.success && booksData.books) {
                                // –ù–∞—Ö–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–Ω–∏–≥–µ –ø–æ bookId –∏–∑ data
                                const book = booksData.books.find(b => b.id === data.bookId);
                                if (book) {
                                    // –û–±–Ω–æ–≤–ª—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º showPaymentSuccess
                                    document.getElementById('book-title').textContent = book.title;
                                    if (book.price) {
                                        document.getElementById('book-price').textContent = `–ë–∞“ì–∞—Å—ã: ${book.price} ‚Ç∏`;
                                    }
                                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º bookTitle –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ showPaymentSuccess
                                    window.bookTitle = book.title;
                                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
                                    showPaymentSuccess();
                                } else {
                                    // –ï—Å–ª–∏ –∫–Ω–∏–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Å –æ–±—â–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
                                    window.bookTitle = "–ö—ñ—Ç–∞–ø";
                                    showPaymentSuccess();
                                }
                            } else {
                                // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –∫–Ω–∏–≥–∞—Ö, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                                window.bookTitle = "–ö—ñ—Ç–∞–ø";
                                showPaymentSuccess();
                            }
                        })
                        .catch(error => {
                            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–Ω–∏–≥–µ:', error);
                            // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                            window.bookTitle = "–ö—ñ—Ç–∞–ø";
                            showPaymentSuccess();
                        });
                } else {
                    // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ –æ –∫–Ω–∏–≥–µ —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                    showPaymentSuccess();
                }
            }
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
